---
description: 
globs: backend/*
alwaysApply: false
---
# Regras Backend - Finnantech V2
## Arquitetura Hexagonal + Testes ObrigatÃ³rios

### ğŸ¯ REGRAS FUNDAMENTAIS OBRIGATÃ“RIAS

**1. ARQUITETURA HEXAGONAL OBRIGATÃ“RIA**
- Toda funcionalidade DEVE seguir Ports & Adapters
- Core nunca depende de infraestrutura
- Dependency Inversion em todas as camadas

**2. TESTES UNITÃRIOS OBRIGATÃ“RIOS**
- Cobertura mÃ­nima: 90%
- Toda funcionalidade nova/alterada DEVE ter testes
- Usar JUnit 5 + Mockito + AssertJ

**3. TESTES DE ARQUITETURA OBRIGATÃ“RIOS**
- ArchUnit para validar regras arquiteturais
- Executar a cada build
- 100% de compliance

---

## ğŸ“ ESTRUTURA OBRIGATÃ“RIA

```
backend/
â”œâ”€â”€ src/main/java/com/finnantech/
â”‚   â”œâ”€â”€ domain/                    # ğŸ”µ CORE - DomÃ­nio da aplicaÃ§Ã£o
â”‚   â”‚   â”œâ”€â”€ entities/              # Entidades de negÃ³cio
â”‚   â”‚   â”œâ”€â”€ valueobjects/          # Value Objects
â”‚   â”‚   â”œâ”€â”€ services/              # ServiÃ§os de domÃ­nio
â”‚   â”‚   â”œâ”€â”€ repositories/          # Interfaces de repositÃ³rio (PORTS)
â”‚   â”‚   â””â”€â”€ exceptions/            # ExceÃ§Ãµes de domÃ­nio
â”‚   â”œâ”€â”€ application/               # ğŸŸ¡ CASOS DE USO
â”‚   â”‚   â”œâ”€â”€ usecases/              # Use Cases
â”‚   â”‚   â”œâ”€â”€ ports/                 # Interfaces (input/output ports)
â”‚   â”‚   â”‚   â”œâ”€â”€ in/                # Input ports (comandos)
â”‚   â”‚   â”‚   â””â”€â”€ out/               # Output ports (interfaces)
â”‚   â”‚   â””â”€â”€ services/              # Application Services
â”‚   â””â”€â”€ infrastructure/            # ğŸŸ¢ ADAPTADORES
â”‚       â”œâ”€â”€ adapters/              # Adaptadores externos
â”‚       â”‚   â”œâ”€â”€ web/               # Controllers REST
â”‚       â”‚   â”œâ”€â”€ persistence/       # ImplementaÃ§Ãµes JPA
â”‚       â”‚   â”œâ”€â”€ messaging/         # Message brokers
â”‚       â”‚   â””â”€â”€ external/          # APIs externas
â”‚       â”œâ”€â”€ config/                # ConfiguraÃ§Ãµes Spring
â”‚       â””â”€â”€ security/              # SeguranÃ§a
â”œâ”€â”€ src/test/java/                 # ğŸ§ª TESTES OBRIGATÃ“RIOS
â”‚   â”œâ”€â”€ unit/                      # Testes unitÃ¡rios
â”‚   â”œâ”€â”€ integration/               # Testes de integraÃ§Ã£o
â”‚   â””â”€â”€ architecture/              # Testes de arquitetura
```

---

## ğŸ—ï¸ IMPLEMENTAÃ‡ÃƒO OBRIGATÃ“RIA

### ğŸ”µ DOMAIN (Core)
```java
// Exemplo: Entidade de DomÃ­nio
@Entity
public class Transaction {
    private TransactionId id;
    private Money amount;
    private TransactionDate date;
    private TransactionType type;
    private Category category;
    
    // Business logic aqui
    public void categorize(Category category) {
        if (this.category != null) {
            throw new TransactionAlreadyCategorizedException();
        }
        this.category = category;
    }
}
```

### ğŸŸ¡ APPLICATION (Use Cases)
```java
// Exemplo: Use Case
@UseCase
public class CreateTransactionUseCase implements CreateTransactionInputPort {
    
    private final TransactionRepository transactionRepository;
    private final NotificationOutputPort notificationPort;
    
    @Override
    public TransactionResponse create(CreateTransactionCommand command) {
        // 1. ValidaÃ§Ãµes de negÃ³cio
        // 2. CriaÃ§Ã£o da entidade
        // 3. PersistÃªncia
        // 4. NotificaÃ§Ãµes
    }
}
```

### ğŸŸ¢ INFRASTRUCTURE (Adapters)
```java
// Exemplo: Adapter de PersistÃªncia
@Component
public class TransactionJpaAdapter implements TransactionRepository {
    
    private final TransactionJpaRepository jpaRepository;
    
    @Override
    public Transaction save(Transaction transaction) {
        return jpaRepository.save(TransactionEntity.from(transaction))
                           .toDomain();
    }
}
```

---

## ğŸ§ª TESTES OBRIGATÃ“RIOS

### âœ… DEFINITION OF DONE

Uma funcionalidade sÃ³ estÃ¡ PRONTA quando:
- âœ… Implementa arquitetura hexagonal
- âœ… Testes unitÃ¡rios â‰¥ 90% cobertura
- âœ… Testes de arquitetura passando
- âœ… Code review aprovado
- âœ… Pipeline CI/CD verde

### ğŸ“ TIPOS DE TESTE OBRIGATÃ“RIOS

**1. Testes UnitÃ¡rios de Entidades**
```java
@Test
@DisplayName("Deve criar transaÃ§Ã£o vÃ¡lida")
void shouldCreateValidTransaction() {
    // Given
    Transaction transaction = TransactionBuilder.create()
        .withAmount(Money.of(100.00))
        .build();
    Category category = CategoryBuilder.create()
        .withName("AlimentaÃ§Ã£o")
        .build();
    
    // When
    transaction.categorize(category);
    
    // Then
    assertThat(transaction.getCategory()).isEqualTo(category);
}
```

**2. Testes de Use Case**
```java
@ExtendWith(MockitoExtension.class)
class CreateTransactionUseCaseTest {
    @Mock TransactionRepository repository;
    @Mock NotificationOutputPort notificationPort;
    @InjectMocks CreateTransactionUseCase useCase;
    
    @Test
    @DisplayName("Deve criar transaÃ§Ã£o com sucesso")
    void shouldCreateTransactionSuccessfully() {
        // Given
        CreateTransactionCommand command = CreateTransactionCommand.builder()
            .amount(BigDecimal.valueOf(100.00))
            .description("Compra no supermercado")
            .build();
        
        Transaction savedTransaction = TransactionBuilder.create()
            .withId(TransactionId.generate())
            .build();
        
        when(repository.save(any(Transaction.class)))
            .thenReturn(savedTransaction);
        
        // When
        TransactionResponse response = useCase.create(command);
        
        // Then
        assertThat(response.getId()).isEqualTo(savedTransaction.getId());
        verify(repository).save(any(Transaction.class));
        verify(notificationPort).sendTransactionCreatedNotification(any());
    }
}
```

**3. Testes de Arquitetura (OBRIGATÃ“RIOS)**
```java
class ArchitectureTest {
    
    @ArchTest
    static final ArchRule domainShouldNotDependOnInfrastructure = 
        noClasses()
            .that().resideInAPackage("..domain..")
            .should().dependOnClassesThat()
            .resideInAPackage("..infrastructure..");
    
    @ArchTest
    static final ArchRule applicationShouldNotDependOnInfrastructure = 
        noClasses()
            .that().resideInAPackage("..application..")
            .should().dependOnClassesThat()
            .resideInAPackage("..infrastructure..");
    
    @ArchTest
    static final ArchRule onlyUseCasesShouldBeAnnotatedWithUseCase =
        classes()
            .that().areAnnotatedWith(UseCase.class)
            .should().resideInAPackage("..application.usecases..");
}
```

---

## ğŸ›  FERRAMENTAS OBRIGATÃ“RIAS

### Stack TecnolÃ³gico
- **Framework**: Spring Boot 3.2+
- **Java**: 17+ (LTS)
- **Build**: Maven
- **Database**: MySQL 8.0+ / H2 (desenvolvimento)
- **Tests**: JUnit 5 + Mockito + ArchUnit + TestContainers

### DependÃªncias Essenciais
```xml
<dependencies>
    <!-- Spring Boot -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    
    <!-- Tests -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <scope>test</scope>
    </dependency>
    
    <dependency>
        <groupId>org.assertj</groupId>
        <artifactId>assertj-core</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- ArchUnit -->
    <dependency>
        <groupId>com.tngtech.archunit</groupId>
        <artifactId>archunit-junit5</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

---

## ğŸ“ PADRÃ•ES OBRIGATÃ“RIOS

### Nomenclatura
- **Entidades**: `Transaction`, `User`, `Category`
- **Value Objects**: `Money`, `TransactionDate`, `UserId`
- **Use Cases**: `CreateTransactionUseCase`, `GetUserProfileUseCase`
- **Repositories**: `TransactionRepository` (interface), `TransactionJpaAdapter` (implementaÃ§Ã£o)
- **Controllers**: `TransactionController`, `UserController`

### AnotaÃ§Ãµes Customizadas
```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Service
public @interface UseCase {
}

@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Component
public @interface DomainService {
}
```

### Tratamento de Erros
```java
// Domain Exception
public class TransactionAlreadyCategorizedException extends DomainException {
    public TransactionAlreadyCategorizedException() {
        super("Transaction is already categorized and cannot be categorized again");
    }
}

// Global Exception Handler
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(DomainException.class)
    public ResponseEntity<ErrorResponse> handleDomainException(DomainException ex) {
        return ResponseEntity.badRequest()
            .body(ErrorResponse.builder()
                .message(ex.getMessage())
                .timestamp(Instant.now())
                .build());
    }
}
```

---

## âš™ï¸ COMANDOS DE VERIFICAÃ‡ÃƒO

### Antes de qualquer commit
```bash
cd backend

# Roda todos os testes
mvn clean test

# Gera relatÃ³rio de cobertura
mvn jacoco:report

# Valida regras arquiteturais
mvn archunit:verify

# Compila o projeto
mvn compile
```

---

## ğŸš¨ REGRAS CRÃTICAS - NUNCA QUEBRAR

1. **NUNCA** viole a arquitetura hexagonal
2. **SEMPRE** implemente testes antes ou junto com o cÃ³digo
3. **JAMAIS** faÃ§a merge sem 90% de cobertura de testes
4. **OBRIGATÃ“RIO** revisar cÃ³digo com foco em arquitetura
5. **SEMPRE** documente APIs com OpenAPI 3.0
6. **NUNCA** coloque lÃ³gica de negÃ³cio em Controllers
7. **SEMPRE** use interfaces para dependencies entre camadas
8. **NUNCA** acesse diretamente repositÃ³rios JPA do domÃ­nio

> **Lembre-se**: Qualidade nÃ£o Ã© negociÃ¡vel. CÃ³digo sem testes Ã© cÃ³digo quebrado esperando para acontecer.
